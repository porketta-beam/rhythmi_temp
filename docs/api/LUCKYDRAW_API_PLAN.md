# ê²½í’ˆì¶”ì²¨ API ì‘ì—… ê³„íš

## ğŸ“‹ ê°œìš”

ê²½í’ˆì¶”ì²¨ ê¸°ëŠ¥ì„ ìœ„í•œ API ì—”ë“œí¬ì¸íŠ¸ ë° ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ êµ¬í˜„ (ì •ìš° íŒŒíŠ¸)
- ì›¹ì†Œì¼“ ì—°ê²° ë° í™”ë©´ êµ¬ì„± ì œì™¸
- Async ê¸°ë°˜ êµ¬í˜„
- **DB ì‚¬ìš© ì—†ì´ ì„œë²„ ë©”ëª¨ë¦¬ ê¸°ë°˜ìœ¼ë¡œë§Œ ë™ì‘** (ì„œë²„ ì¬ì‹œì‘ ì‹œ ë°ì´í„° ì´ˆê¸°í™”)

---

## ğŸ—‚ï¸ íŒŒì¼ êµ¬ì¡°

```
server/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ __init__.py                    # luckydraw_router ì¶”ê°€
â”‚   â””â”€â”€ luckydraw.py                   # ğŸ†• ê²½í’ˆì¶”ì²¨ API ë¼ìš°í„°
â”œâ”€â”€ services/
â”‚   â””â”€â”€ luckydraw_service.py           # ğŸ†• ê²½í’ˆì¶”ì²¨ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (ë©”ëª¨ë¦¬ ê¸°ë°˜)
â””â”€â”€ main.py                            # luckydraw_router ë“±ë¡
```

---

## ğŸ’¾ ë°ì´í„° ì €ì¥ ë°©ì‹ (ë©”ëª¨ë¦¬ ê¸°ë°˜)

### ì„œë²„ ë©”ëª¨ë¦¬ êµ¬ì¡°

```python
# ì„œë²„ ë©”ëª¨ë¦¬ì— ì €ì¥ë˜ëŠ” ë°ì´í„° êµ¬ì¡°
luckydraw_storage = {
    "event_id_1": {
        "participants": {
            "session_token_abc123": {
                "draw_number": 1,
                "created_at": "2025-11-21T10:00:00Z"
            },
            "session_token_def456": {
                "draw_number": 2,
                "created_at": "2025-11-21T10:01:00Z"
            }
        },
        "draws": [
            {
                "prize_name": "1ë“± ìƒ",
                "prize_rank": 1,
                "draw_number": 42,
                "drawn_at": "2025-11-21T15:00:00Z"
            }
        ],
        "next_draw_number": 3  # ë‹¤ìŒ í• ë‹¹ë  ì¶”ì²¨ë²ˆí˜¸
    },
    "event_id_2": {
        # ...
    }
}
```

### ë°ì´í„° êµ¬ì¡° ìƒì„¸

1. **ì°¸ê°€ì ì •ë³´** (`participants`)
   - Key: `session_token` (ì„¸ì…˜ í† í°)
   - Value: `{draw_number, created_at}`
   - ì´ë²¤íŠ¸ë³„ë¡œ ë…ë¦½ì ìœ¼ë¡œ ê´€ë¦¬

2. **ì¶”ì²¨ ì´ë ¥** (`draws`)
   - ë°°ì—´ í˜•íƒœë¡œ ìƒí’ˆë³„ ì¶”ì²¨ ê¸°ë¡ ì €ì¥
   - `{prize_name, prize_rank, draw_number, drawn_at}`

3. **ë‹¤ìŒ ì¶”ì²¨ë²ˆí˜¸** (`next_draw_number`)
   - ì´ë²¤íŠ¸ë³„ë¡œ ìë™ ì¦ê°€í•˜ëŠ” ì¶”ì²¨ë²ˆí˜¸ ì¹´ìš´í„°

### íŠ¹ì§•
- âœ… **ì„œë²„ ì¬ì‹œì‘ ì‹œ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”** (ì˜êµ¬ ì €ì¥ ì•ˆ í•¨)
- âœ… **ì´ë²¤íŠ¸ë³„ë¡œ ë…ë¦½ì ì¸ ë°ì´í„° ê´€ë¦¬**
- âœ… **ìŠ¤ë ˆë“œ ì•ˆì „ì„± ê³ ë ¤** (asyncio.Lock ì‚¬ìš©)

---

## ğŸ”Œ API ì—”ë“œí¬ì¸íŠ¸

### 1. ì°¸ê°€ì API (`/api/luckydraw`)

#### `POST /api/luckydraw/register`
QR ì½”ë“œ ìŠ¤ìº” ì‹œ ì¶”ì²¨ë²ˆí˜¸ í• ë‹¹ ë° ì„¸ì…˜ í† í° ë°œê¸‰

**Request:**
```json
{
  "event_id": "uuid",
  "session_token": "optional-existing-token"
}
```

**Response (ì‹ ê·œ ë“±ë¡):**
```json
{
  "success": true,
  "data": {
    "draw_number": 42,
    "session_token": "abc123...",
    "event_id": "uuid"
  }
}
```

**Response (ê¸°ì¡´ í† í°ìœ¼ë¡œ ì¬ì ‘ì†):**
```json
{
  "success": true,
  "data": {
    "draw_number": 42,
    "session_token": "abc123...",
    "event_id": "uuid",
    "is_existing": true
  }
}
```

#### `GET /api/luckydraw/my-number`
ì„¸ì…˜ í† í°ìœ¼ë¡œ ë‚´ ì¶”ì²¨ë²ˆí˜¸ ì¡°íšŒ

**Headers:**
```
Authorization: Bearer {session_token}
```

ë˜ëŠ”

**Query:**
```
?session_token={token}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "draw_number": 42,
    "event_id": "uuid"
  }
}
```

---

### 2. ê´€ë¦¬ì API (`/api/luckydraw/admin`)

#### `GET /api/luckydraw/admin/{event_id}/participants`
í• ë‹¹ëœ ì¶”ì²¨ë²ˆí˜¸ ëª©ë¡ ì¡°íšŒ

**Response:**
```json
{
  "success": true,
  "data": {
    "total_count": 150,
    "participants": [
      {
        "draw_number": 1,
        "created_at": "2025-11-21T10:00:00Z"
      },
      {
        "draw_number": 2,
        "created_at": "2025-11-21T10:01:00Z"
      }
    ]
  }
}
```

#### `POST /api/luckydraw/admin/{event_id}/draw`
ì¶”ì²¨ ì‹œì‘

**Request:**
```json
{
  "prize_name": "1ë“± ìƒ",
  "prize_rank": 1,
  "count": 1                    -- ë‹¹ì²¨ì ìˆ˜ (ê¸°ë³¸ê°’: 1)
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "prize_name": "1ë“± ìƒ",
    "prize_rank": 1,
    "winners": [
      {
        "draw_number": 42,
        "participant_id": "uuid"
      }
    ],
    "drawn_at": "2025-11-21T15:00:00Z"
  }
}
```

#### `POST /api/luckydraw/admin/{event_id}/reset`
ë¦¬ì…‹ / ë‹¤ì‹œ ì‹œì‘ (ê´€ë¦¬ì í˜ì´ì§€ì˜ ë¦¬ì…‹ ë²„íŠ¼ìœ¼ë¡œ í˜¸ì¶œ)

**Request:**
```json
{
  "reset_participants": false,  -- ì°¸ê°€ì ëª©ë¡ë„ ì‚­ì œí• ì§€ (ê¸°ë³¸ê°’: false)
  "reset_draws": true            -- ì¶”ì²¨ ì´ë ¥ ì‚­ì œ (ê¸°ë³¸ê°’: true)
}
```

**Response:**
```json
{
  "success": true,
  "message": "ì¶”ì²¨ ì´ë ¥ì´ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤"
}
```

**ì°¸ê³ **: ì´ ì—”ë“œí¬ì¸íŠ¸ëŠ” ê´€ë¦¬ì í˜ì´ì§€ì˜ ë¦¬ì…‹ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë©ë‹ˆë‹¤.

---

## ğŸ”§ êµ¬í˜„ ì„¸ë¶€ì‚¬í•­

### 1. ë©”ëª¨ë¦¬ ìŠ¤í† ë¦¬ì§€ ê´€ë¦¬
- **êµ¬ì¡°**: Python ë”•ì…”ë„ˆë¦¬ ê¸°ë°˜ ì¸ë©”ëª¨ë¦¬ ìŠ¤í† ë¦¬ì§€
- **ìŠ¤ë ˆë“œ ì•ˆì „ì„±**: `asyncio.Lock` ì‚¬ìš©í•˜ì—¬ ë™ì‹œì„± ì œì–´
- **ì´ˆê¸°í™”**: ì„œë²„ ì‹œì‘ ì‹œ ë¹ˆ ë”•ì…”ë„ˆë¦¬ë¡œ ì´ˆê¸°í™”
- **ì´ë²¤íŠ¸ë³„ ê²©ë¦¬**: ê° ì´ë²¤íŠ¸ë³„ë¡œ ë…ë¦½ì ì¸ ë°ì´í„° ê³µê°„

### 2. ì„¸ì…˜ í† í° ê´€ë¦¬
- **ìƒì„±**: `secrets.token_urlsafe(32)` ë˜ëŠ” UUID v4 ê¸°ë°˜ ëœë¤ í† í° ìƒì„±
- **ì €ì¥**: ë©”ëª¨ë¦¬ ë”•ì…”ë„ˆë¦¬ `participants[session_token]`ì— ì €ì¥
- **ê²€ì¦**: í† í°ìœ¼ë¡œ ì°¸ê°€ì ì¡°íšŒ â†’ ë™ì¼í•œ ì¶”ì²¨ë²ˆí˜¸ ë°˜í™˜
- **ë§Œë£Œ**: ì„œë²„ ì¬ì‹œì‘ ì‹œê¹Œì§€ ìœ ì§€ (ì˜êµ¬ ì €ì¥ ì•ˆ í•¨)

### 3. ì¶”ì²¨ë²ˆí˜¸ í• ë‹¹ ë¡œì§
1. ì´ë²¤íŠ¸ë³„ `next_draw_number` ì¡°íšŒ
2. `next_draw_number` í• ë‹¹ í›„ `+1` ì¦ê°€
3. ì„¸ì…˜ í† í°ê³¼ í•¨ê»˜ `participants` ë”•ì…”ë„ˆë¦¬ì— ì €ì¥
4. `created_at` íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë¡

### 4. ì¶”ì²¨ ë¡œì§
1. í•´ë‹¹ ì´ë²¤íŠ¸ì˜ `participants` ë”•ì…”ë„ˆë¦¬ì—ì„œ ëª¨ë“  ì¶”ì²¨ë²ˆí˜¸ ìˆ˜ì§‘
2. ì´ë¯¸ ë‹¹ì²¨ëœ ë²ˆí˜¸(`draws` ë°°ì—´ì—ì„œ í™•ì¸) ì œì™¸
3. ë‚¨ì€ ë²ˆí˜¸ ì¤‘ ëœë¤ ì„ íƒ (`random.choice()`)
4. `draws` ë°°ì—´ì— ì¶”ì²¨ ê¸°ë¡ ì¶”ê°€
5. ë‹¹ì²¨ì ì •ë³´ ë°˜í™˜

### 4. ì—ëŸ¬ ì²˜ë¦¬
- **400 Bad Request**: ì˜ëª»ëœ ìš”ì²­ ë°ì´í„°
- **404 Not Found**: ì´ë²¤íŠ¸ ë˜ëŠ” ì°¸ê°€ì ì—†ìŒ
- **409 Conflict**: ì¶”ì²¨ë²ˆí˜¸ ì¤‘ë³µ (ì¬ì‹œë„ ë¡œì§ í•„ìš”)
- **500 Internal Server Error**: ì„œë²„ ì˜¤ë¥˜

---

## ğŸ“ êµ¬í˜„ ìˆœì„œ

1. âœ… ì‘ì—… ê³„íš ë° íŒŒì¼ êµ¬ì¡° ì œì•ˆ
2. `server/services/luckydraw_service.py` êµ¬í˜„
   - ë©”ëª¨ë¦¬ ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤/ëª¨ë“ˆ êµ¬í˜„
   - ì¶”ì²¨ë²ˆí˜¸ í• ë‹¹ ë¡œì§ (ë©”ëª¨ë¦¬ ê¸°ë°˜)
   - ì„¸ì…˜ í† í° ìƒì„±/ê²€ì¦
   - ì¶”ì²¨ ë¡œì§ (ë©”ëª¨ë¦¬ ê¸°ë°˜)
   - ë¦¬ì…‹ ë¡œì§
   - ìŠ¤ë ˆë“œ ì•ˆì „ì„± ë³´ì¥ (asyncio.Lock)
3. `server/api/luckydraw.py` êµ¬í˜„
   - ì°¸ê°€ì API ì—”ë“œí¬ì¸íŠ¸
   - ê´€ë¦¬ì API ì—”ë“œí¬ì¸íŠ¸
   - Pydantic ëª¨ë¸ ì •ì˜
4. `server/api/__init__.py`ì— ë¼ìš°í„° ì¶”ê°€
5. `server/main.py`ì— ë¼ìš°í„° ë“±ë¡
6. í…ŒìŠ¤íŠ¸

---

## ğŸ” ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

1. **ì„¸ì…˜ í† í°**: `secrets.token_urlsafe(32)` ì‚¬ìš©í•˜ì—¬ ì¶©ë¶„íˆ ê¸´ ëœë¤ ë¬¸ìì—´ ìƒì„±
2. **ê´€ë¦¬ì ì¸ì¦**: ì¶”í›„ JWT ê¸°ë°˜ ì¸ì¦ ì¶”ê°€ í•„ìš” (í˜„ì¬ëŠ” event_idë§Œ ê²€ì¦)
3. **CORS**: ê¸°ì¡´ CORS ì„¤ì • í™œìš©
4. **ë™ì‹œì„± ì œì–´**: `asyncio.Lock`ì„ ì‚¬ìš©í•˜ì—¬ ë™ì‹œ ìš”ì²­ ì‹œ ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥
5. **ë©”ëª¨ë¦¬ ì œí•œ**: ëŒ€ëŸ‰ ì°¸ê°€ì ì‹œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§ í•„ìš” (ì„ íƒì‚¬í•­)

---

## ğŸ“Œ ì°¸ê³ ì‚¬í•­

- **DB ì‚¬ìš© ì•ˆ í•¨**: ëª¨ë“  ë°ì´í„°ëŠ” ì„œë²„ ë©”ëª¨ë¦¬ì—ë§Œ ì €ì¥ë˜ë©°, ì„œë²„ ì¬ì‹œì‘ ì‹œ ì´ˆê¸°í™”ë¨
- **ì›¹ì†Œì¼“ ì—°ê²°**: ë³„ë„ ì‘ì—… (ì •ìˆ˜ íŒŒíŠ¸)
- **í™”ë©´ êµ¬ì„±**: ë³„ë„ ì‘ì—… (ìœ¤ì„œ íŒŒíŠ¸)
- **ì¶”ì²¨ í˜ì´ì§€ ì‹œì•ˆ**: ë‚˜ì¤‘ì— ì„ íƒ
- **ë…¸ë“œë§ˆë‹¤ ë²ˆí˜¸ í‘œì‹œ ê¸°ëŠ¥**: nice to have
- **ë¦¬ì…‹ ê¸°ëŠ¥**: ê´€ë¦¬ì í˜ì´ì§€ì˜ ë²„íŠ¼ìœ¼ë¡œ ì‹¤í–‰ë˜ë©°, `/admin/{event_id}/reset` ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ

