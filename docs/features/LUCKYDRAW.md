# ê²½í’ˆ ì¶”ì²¨ (Lucky Draw) ê¸°ëŠ¥ ëª…ì„¸

**ë²„ì „**: 1.0
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-11-30
**ì‘ì„±ì**: ê°œë°œíŒ€

---

## ğŸ“‹ ê°œìš”

### ê¸°ëŠ¥ ì„¤ëª…
í–‰ì‚¬ì¥ì—ì„œ QR ì½”ë“œ ê¸°ë°˜ìœ¼ë¡œ ì°¸ê°€ìë¥¼ ë“±ë¡í•˜ê³ , ì‹¤ì‹œê°„ìœ¼ë¡œ ê²½í’ˆ ì¶”ì²¨ì„ ì§„í–‰í•˜ëŠ” ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

### í•µì‹¬ ê°€ì¹˜
- ğŸ¯ **ê³µì •í•œ ì¶”ì²¨**: ì„œë²„ì—ì„œ ëœë¤ ì¶”ì²¨ìœ¼ë¡œ íˆ¬ëª…ì„± ë³´ì¥
- âš¡ **ì‹¤ì‹œê°„ ì•Œë¦¼**: ë‹¹ì²¨ìì—ê²Œ ì¦‰ì‹œ ì•Œë¦¼ (WebSocket ì˜ˆì •)
- ğŸ“± **ëª¨ë°”ì¼ ì¹œí™”ì **: QR ì½”ë“œ ìŠ¤ìº”ìœ¼ë¡œ ê°„í¸ ì°¸ì—¬
- ğŸ¨ **ì‹œê°ì  íš¨ê³¼**: ìŠ¬ë¡¯ë¨¸ì‹  ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ í¥ë¯¸ ìœ ë°œ

### ì‹œìŠ¤í…œ êµ¬ì„±
| êµ¬ì„± ìš”ì†Œ | ìš©ë„ | ê²½ë¡œ |
|----------|------|------|
| **í”„ë ˆì  í…Œì´ì…˜ í˜ì´ì§€** | í–‰ì‚¬ì¥ í™”ë©´ì— QRì½”ë“œ ë° ì¶”ì²¨ ê²°ê³¼ í‘œì‹œ | `/lottery` |
| **ê´€ë¦¬ì í˜ì´ì§€** | ìƒí’ˆ ë“±ë¡, ì¶”ì²¨ ì‹œì‘, ê²°ê³¼ ê´€ë¦¬ | `/lottery/admin` |
| **ì°¸ì—¬ì ëŒ€ê¸° í˜ì´ì§€** | í–‰ìš´ë²ˆí˜¸ í‘œì‹œ, ë‹¹ì²¨ ì•Œë¦¼ | `/lottery/waiting` |
| **ì„œë²„ API** | ì°¸ê°€ì ë“±ë¡, ì¶”ì²¨ ë¡œì§, ê²°ê³¼ ê´€ë¦¬ | `/api/luckydraw/*` |

---

## ğŸ”„ ì‚¬ìš©ì íë¦„ (User Flow)

### ì „ì²´ ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  í”„ë ˆì  í…Œì´ì…˜  â”‚     â”‚   ì°¸ì—¬ì     â”‚     â”‚   ê´€ë¦¬ì     â”‚     â”‚   ì„œë²„      â”‚
â”‚   (í™”ë©´)     â”‚     â”‚  (ëª¨ë°”ì¼)    â”‚     â”‚  (PC/íƒœë¸”ë¦¿)  â”‚     â”‚  (FastAPI)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚                   â”‚                   â”‚
       â”‚â—€â”€â”€â”€â”€ QR ì½”ë“œ í‘œì‹œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
       â”‚                   â”‚                   â”‚                   â”‚
       â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                   â”‚
       â”‚    â”‚ QR ìŠ¤ìº”      â”‚                   â”‚                   â”‚
       â”‚    â–¼              â”‚                   â”‚                   â”‚
       â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ /lottery/waiting ì ‘ì† â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                   â”‚                   â”‚                   â”‚
       â”‚                   â”œâ”€â”€â”€â”€â”€ POST /register â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
       â”‚                   â”‚                   â”‚                   â”‚
       â”‚                   â”‚â—€â”€â”€â”€â”€ {draw_number, session_token} â”€â”€â”€â”€â”‚
       â”‚                   â”‚                   â”‚                   â”‚
       â”‚                   â”‚  í–‰ìš´ë²ˆí˜¸ í‘œì‹œ     â”‚                   â”‚
       â”‚                   â”‚  "ë‚˜ì˜ ë²ˆí˜¸: 042"  â”‚                   â”‚
       â”‚                   â”‚                   â”‚                   â”‚
       â”‚                   â”‚                   â”‚ ìƒí’ˆ ì„ íƒ ë°       â”‚
       â”‚                   â”‚                   â”‚ "ì¶”ì²¨ ì‹œì‘" í´ë¦­   â”‚
       â”‚                   â”‚                   â”‚                   â”‚
       â”‚                   â”‚                   â”œâ”€â”€ POST /draw â”€â”€â”€â”€â–¶â”‚
       â”‚                   â”‚                   â”‚                   â”‚
       â”‚                   â”‚                   â”‚â—€â”€â”€â”€ {winner} â”€â”€â”€â”€â”€â”‚
       â”‚                   â”‚                   â”‚                   â”‚
       â”‚â—€â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ë‹¹ì²¨ ë²ˆí˜¸ ë¸Œë¡œë“œìºìŠ¤íŠ¸ (WebSocket) â•â•â•â•â•â•â”‚
       â”‚                   â”‚                   â”‚                   â”‚
       â”‚  ìŠ¬ë¡¯ë¨¸ì‹  ì• ë‹ˆë©”ì´ì…˜  â”‚                   â”‚                   â”‚
       â”‚  ë‹¹ì²¨ ë²ˆí˜¸ í‘œì‹œ      â”‚                   â”‚                   â”‚
       â”‚                   â”‚                   â”‚                   â”‚
       â”‚                   â”‚â—€â•â•â• ë‹¹ì²¨ ì•Œë¦¼ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
       â”‚                   â”‚  (ë‚´ ë²ˆí˜¸ê°€ ë‹¹ì²¨!)   â”‚                   â”‚
       â”‚                   â”‚                   â”‚                   â”‚
       â–¼                   â–¼                   â–¼                   â–¼
```

### ë‹¨ê³„ë³„ ìƒì„¸ íë¦„

#### Phase 1: ì°¸ê°€ì ë“±ë¡
```
1. [í”„ë ˆì  í…Œì´ì…˜] QR ì½”ë“œ í‘œì‹œ (waiting í˜ì´ì§€ URL í¬í•¨)
2. [ì°¸ì—¬ì] QR ì½”ë“œ ìŠ¤ìº” â†’ /lottery/waiting ì ‘ì†
3. [ì°¸ì—¬ì] ìë™ìœ¼ë¡œ ì„œë²„ì— ë“±ë¡ ìš”ì²­ (POST /api/luckydraw/register)
4. [ì„œë²„] ì„¸ì…˜ í† í° + í–‰ìš´ë²ˆí˜¸ ë°œê¸‰ (ì˜ˆ: 042)
5. [ì°¸ì—¬ì] í–‰ìš´ë²ˆí˜¸ í™”ë©´ì— í‘œì‹œ, í† í° sessionStorageì— ì €ì¥
```

#### Phase 2: ì¶”ì²¨ ì¤€ë¹„
```
1. [ê´€ë¦¬ì] ìƒí’ˆ ë“±ë¡ (ì´ë¦„, ì„¤ëª…, ìˆ˜ëŸ‰, ì´ë¯¸ì§€)
2. [ê´€ë¦¬ì] ì¶”ì²¨í•  ìƒí’ˆ ì„ íƒ
3. [ê´€ë¦¬ì] "ì¶”ì²¨ ì‹œì‘" ë²„íŠ¼ í´ë¦­
```

#### Phase 3: ì¶”ì²¨ ì‹¤í–‰
```
1. [ê´€ë¦¬ì] POST /api/luckydraw/admin/{event_id}/draw í˜¸ì¶œ
2. [ì„œë²„] ë“±ë¡ëœ ì°¸ê°€ì ì¤‘ ëœë¤ìœ¼ë¡œ ë‹¹ì²¨ì ì„ íƒ
3. [ì„œë²„] ë‹¹ì²¨ ê²°ê³¼ë¥¼ ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ì— ë¸Œë¡œë“œìºìŠ¤íŠ¸ (WebSocket)
4. [í”„ë ˆì  í…Œì´ì…˜] ìŠ¬ë¡¯ë¨¸ì‹  ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ë‹¹ì²¨ ë²ˆí˜¸ í‘œì‹œ
5. [ì°¸ì—¬ì] ë³¸ì¸ ë²ˆí˜¸ì™€ ë‹¹ì²¨ ë²ˆí˜¸ ë¹„êµ â†’ ë‹¹ì²¨ ì‹œ ì¶•í•˜ í™”ë©´
```

#### Phase 4: ë‹¤ìŒ ì¶”ì²¨ ì¤€ë¹„
```
1. [ê´€ë¦¬ì] ë‹¤ìŒ ì¶”ì²¨í•  ìƒí’ˆ ì„ íƒ
2. [ê´€ë¦¬ì] "ì¶”ì²¨ ì‹œì‘" ë²„íŠ¼ í´ë¦­
3. Phase 3 ë°˜ë³µ
```

---

## ğŸ—‚ï¸ íŒŒì¼ êµ¬ì¡°

```
eventManager/
â”œâ”€â”€ front/src/
â”‚   â”œâ”€â”€ app/lottery/
â”‚   â”‚   â”œâ”€â”€ page.js              # í”„ë ˆì  í…Œì´ì…˜ í˜ì´ì§€
â”‚   â”‚   â”œâ”€â”€ admin/
â”‚   â”‚   â”‚   â””â”€â”€ page.js          # ê´€ë¦¬ì í˜ì´ì§€
â”‚   â”‚   â””â”€â”€ waiting/
â”‚   â”‚       â””â”€â”€ page.js          # ì°¸ì—¬ì ëŒ€ê¸° í˜ì´ì§€
â”‚   â”‚
â”‚   â””â”€â”€ components/lottery/
â”‚       â”œâ”€â”€ SlotMachine.js       # ìŠ¬ë¡¯ë¨¸ì‹  ì»´í¬ë„ŒíŠ¸
â”‚       â”œâ”€â”€ SlotDigit.js         # ìŠ¬ë¡¯ ìˆ«ì ì»´í¬ë„ŒíŠ¸
â”‚       â”œâ”€â”€ AnimatedBackground.js # ë°°ê²½ ì• ë‹ˆë©”ì´ì…˜
â”‚       â””â”€â”€ CelebrationEffect.js # ë‹¹ì²¨ ì¶•í•˜ íš¨ê³¼
â”‚
â””â”€â”€ server/
    â”œâ”€â”€ api/
    â”‚   â””â”€â”€ luckydraw.py         # API ë¼ìš°í„°
    â””â”€â”€ services/
        â””â”€â”€ luckydraw_service.py # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (ë©”ëª¨ë¦¬ ê¸°ë°˜)
```

---

## ğŸ”Œ API ì—”ë“œí¬ì¸íŠ¸

### ì°¸ê°€ì API

#### `POST /api/luckydraw/register`
QR ì½”ë“œ ìŠ¤ìº” ì‹œ ì¶”ì²¨ë²ˆí˜¸ í• ë‹¹ ë° ì„¸ì…˜ í† í° ë°œê¸‰

```json
// Request
{
  "event_id": "uuid",
  "session_token": "optional-existing-token"
}

// Response (ì‹ ê·œ)
{
  "success": true,
  "data": {
    "draw_number": 42,
    "session_token": "abc123...",
    "event_id": "uuid",
    "is_existing": false
  },
  "message": "ë“±ë¡ ì™„ë£Œ"
}
```

#### `GET /api/luckydraw/my-number`
ì„¸ì…˜ í† í°ìœ¼ë¡œ ë‚´ ì¶”ì²¨ë²ˆí˜¸ ì¡°íšŒ

```
Query: ?event_id={id}&session_token={token}
ë˜ëŠ”
Header: Authorization: Bearer {token}
```

### ê´€ë¦¬ì API

#### `GET /api/luckydraw/admin/{event_id}/participants`
ì°¸ê°€ì ëª©ë¡ ì¡°íšŒ

```json
// Response
{
  "success": true,
  "data": {
    "total_count": 150,
    "participants": [
      {"draw_number": 1, "created_at": "2025-11-30T10:00:00Z"},
      {"draw_number": 2, "created_at": "2025-11-30T10:01:00Z"}
    ]
  }
}
```

#### `POST /api/luckydraw/admin/{event_id}/draw`
ì¶”ì²¨ ì‹¤í–‰

```json
// Request
{
  "prize_name": "1ë“± ìƒ",
  "prize_rank": 1,
  "count": 1
}

// Response
{
  "success": true,
  "data": {
    "prize_name": "1ë“± ìƒ",
    "prize_rank": 1,
    "winners": [{"draw_number": 42}],
    "drawn_at": "2025-11-30T15:00:00Z"
  }
}
```

#### `POST /api/luckydraw/admin/{event_id}/reset`
ì¶”ì²¨ ë¦¬ì…‹

```json
// Request
{
  "reset_participants": false,  // ì°¸ê°€ìë„ ì‚­ì œí• ì§€
  "reset_draws": true           // ì¶”ì²¨ ì´ë ¥ ì‚­ì œ
}
```

#### `GET /api/luckydraw/admin/{event_id}/draws`
ì¶”ì²¨ ì´ë ¥ ì¡°íšŒ

---

## ğŸ—ï¸ í˜„ì¬ êµ¬í˜„ ìƒíƒœ

### âœ… ì™„ë£Œ
- [x] ë°±ì—”ë“œ API (luckydraw.py, luckydraw_service.py)
- [x] ë©”ëª¨ë¦¬ ê¸°ë°˜ ë°ì´í„° ì €ì¥
- [x] asyncio.Lock ê¸°ë°˜ ë™ì‹œì„± ì œì–´
- [x] í”„ë ˆì  í…Œì´ì…˜ í˜ì´ì§€ UI (ìŠ¬ë¡¯ë¨¸ì‹  ì• ë‹ˆë©”ì´ì…˜)
- [x] ê´€ë¦¬ì í˜ì´ì§€ UI (ìƒí’ˆ ë“±ë¡, ì¶”ì²¨ ì‹œì‘)
- [x] ì°¸ì—¬ì ëŒ€ê¸° í˜ì´ì§€ UI (í–‰ìš´ë²ˆí˜¸ í‘œì‹œ)

### ğŸ”„ ì§„í–‰ ì¤‘ / ë¯¸ì™„ë£Œ
- [ ] **í”„ë¡ íŠ¸ì—”ë“œ â†” ì„œë²„ API ì—°ë™** (í˜„ì¬ localStorage ê¸°ë°˜)
- [ ] **WebSocket ì‹¤ì‹œê°„ í†µì‹ ** (ë‹¹ì²¨ì ì•Œë¦¼)
- [ ] QR ì½”ë“œ ìƒì„± ë° í‘œì‹œ
- [ ] ë‹¹ì²¨ì ì¸ì¦ ë¡œì§ (ë²ˆí˜¸ í™•ì¸ ë°©ë²•)
- [ ] ì¶”ì²¨ ê²°ê³¼ ì˜êµ¬ ì €ì¥ (DB ì—°ë™)

### âš ï¸ ì•Œë ¤ì§„ ì œí•œì‚¬í•­
1. **ì„œë²„ ì¬ì‹œì‘ ì‹œ ë°ì´í„° ì´ˆê¸°í™”**: ë©”ëª¨ë¦¬ ê¸°ë°˜ì´ë¯€ë¡œ ëª¨ë“  ì°¸ê°€ì/ì¶”ì²¨ ì´ë ¥ ì†ì‹¤
2. **ë‹¨ì¼ ì„œë²„ í™˜ê²½ ì „ì œ**: ì—¬ëŸ¬ ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ë©”ëª¨ë¦¬ ê³µìœ  ë¶ˆê°€
3. **ì‹¤ì‹œê°„ í†µì‹  ë¯¸êµ¬í˜„**: ë‹¹ì²¨ ê²°ê³¼ë¥¼ ìˆ˜ë™ìœ¼ë¡œ í™•ì¸í•´ì•¼ í•¨

---

## ğŸ“± í™”ë©´ë³„ ê¸°ëŠ¥

### í”„ë ˆì  í…Œì´ì…˜ í˜ì´ì§€ (`/lottery`)

**ëª©ì **: í–‰ì‚¬ì¥ ëŒ€í˜• í™”ë©´ì— í‘œì‹œ

**ì£¼ìš” ê¸°ëŠ¥**:
- QR ì½”ë“œ í‘œì‹œ (waiting í˜ì´ì§€ URL)
- í˜„ì¬ ì¶”ì²¨ ì¤‘ì¸ ìƒí’ˆ ì •ë³´
- ìŠ¬ë¡¯ë¨¸ì‹  ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ë‹¹ì²¨ ë²ˆí˜¸ í‘œì‹œ
- ë‹¹ì²¨ ì¶•í•˜ íš¨ê³¼

**ìƒíƒœ**:
- `idle`: ëŒ€ê¸° ìƒíƒœ
- `spinning`: ìŠ¬ë¡¯ íšŒì „ ì¤‘
- `stopping`: ìŠ¬ë¡¯ ì •ì§€ ì¤‘
- `winner`: ë‹¹ì²¨ ë²ˆí˜¸ í™•ì •

### ê´€ë¦¬ì í˜ì´ì§€ (`/lottery/admin`)

**ëª©ì **: ì£¼ìµœìê°€ ì¶”ì²¨ ê´€ë¦¬

**ì£¼ìš” ê¸°ëŠ¥**:
- ìƒí’ˆ ë“±ë¡ (ì´ë¦„, ì„¤ëª…, ìˆ˜ëŸ‰, ì´ë¯¸ì§€)
- ìƒí’ˆ ëª©ë¡ ì¡°íšŒ ë° ì‚­ì œ
- ìƒí’ˆ ì„ íƒ í›„ ì¶”ì²¨ ì‹œì‘
- ì¶”ì²¨ ê²°ê³¼ ì¡°íšŒ
- ì „ì²´ ë¦¬ì…‹

**ë°ì´í„° ì €ì¥**:
- í˜„ì¬: localStorage (admin_prizes, admin_results)
- ì˜ˆì •: ì„œë²„ API ì—°ë™

### ì°¸ì—¬ì ëŒ€ê¸° í˜ì´ì§€ (`/lottery/waiting`)

**ëª©ì **: ì°¸ì—¬ìê°€ ë³¸ì¸ ë²ˆí˜¸ í™•ì¸ ë° ë‹¹ì²¨ ëŒ€ê¸°

**ì£¼ìš” ê¸°ëŠ¥**:
- ìë™ í–‰ìš´ë²ˆí˜¸ ë°œê¸‰ ë° í‘œì‹œ
- í˜„ì¬ ì¶”ì²¨ ì¤‘ì¸ ìƒí’ˆ í‘œì‹œ
- ë‹¹ì²¨ ì‹œ ì¶•í•˜ í™”ë©´

**ë°ì´í„° ì €ì¥**:
- í˜„ì¬: sessionStorage (ticketNumber)
- ì˜ˆì •: ì„œë²„ API ì—°ë™ (session_token)

---

## ğŸ”’ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

1. **ì„¸ì…˜ í† í°**: `secrets.token_urlsafe(32)` ì‚¬ìš© (ì¶©ë¶„íˆ ê¸´ ëœë¤ ë¬¸ìì—´)
2. **ì¤‘ë³µ ë°©ì§€**: ë™ì¼ í† í°ìœ¼ë¡œ ì¬ì ‘ì† ì‹œ ê¸°ì¡´ ë²ˆí˜¸ ë°˜í™˜
3. **ë™ì‹œì„± ì œì–´**: `asyncio.Lock`ìœ¼ë¡œ ë²ˆí˜¸ í• ë‹¹ ì¶©ëŒ ë°©ì§€
4. **ê´€ë¦¬ì ì¸ì¦**: í˜„ì¬ ë¯¸êµ¬í˜„ â†’ ì¶”í›„ JWT ê¸°ë°˜ ì¸ì¦ ì¶”ê°€ í•„ìš”

---

## ğŸ“Š ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­

### 300ëª… ë™ì‹œ ì ‘ì† ì‹œë‚˜ë¦¬ì˜¤

**ë¬¸ì œ ìƒí™©**:
- QR ì½”ë“œ ê³µê°œ ì‹œ 300ëª…ì´ ê±°ì˜ ë™ì‹œì— `/api/luckydraw/register` í˜¸ì¶œ
- Vercel Serverless í™˜ê²½ì—ì„œ FastAPI ì²˜ë¦¬ ê°€ëŠ¥ ì—¬ë¶€

**í˜„ì¬ êµ¬í˜„ì˜ ì²˜ë¦¬ ë°©ì‹**:
```python
# asyncio.Lockìœ¼ë¡œ ìˆœì°¨ ì²˜ë¦¬
async with lock:
    draw_number = event_data["next_draw_number"]
    event_data["next_draw_number"] += 1
    # ...
```

### 300ëª… ë™ì‹œ ì ‘ì† ì²˜ë¦¬ ë¶„ì„

#### ğŸ”´ í˜„ì¬ ì•„í‚¤í…ì²˜ì˜ í•µì‹¬ ë¬¸ì œì 

**1. Vercel Serverlessì˜ ë©”ëª¨ë¦¬ ê²©ë¦¬ ë¬¸ì œ**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    QR ìŠ¤ìº” (300ëª… ë™ì‹œ)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â–¼                  â–¼                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Instance A  â”‚   â”‚  Instance B  â”‚   â”‚  Instance C  â”‚
    â”‚  Memory: {}  â”‚   â”‚  Memory: {}  â”‚   â”‚  Memory: {}  â”‚
    â”‚  Lock: A     â”‚   â”‚  Lock: B     â”‚   â”‚  Lock: C     â”‚
    â”‚  ë²ˆí˜¸: 1,2,3  â”‚   â”‚  ë²ˆí˜¸: 1,2,3  â”‚   â”‚  ë²ˆí˜¸: 1,2,3  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                     âš ï¸ ë²ˆí˜¸ ì¤‘ë³µ ë°œìƒ!
```

- **Vercel Serverless**ëŠ” ìš”ì²­ëŸ‰ì— ë”°ë¼ ì—¬ëŸ¬ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìë™ ìƒì„±
- ê° ì¸ìŠ¤í„´ìŠ¤ëŠ” **ë…ë¦½ëœ ë©”ëª¨ë¦¬**ì™€ **ë…ë¦½ëœ asyncio.Lock**ì„ ê°€ì§
- `_luckydraw_storage`ëŠ” ì¸ìŠ¤í„´ìŠ¤ ê°„ì— **ê³µìœ ë˜ì§€ ì•ŠìŒ**
- ê²°ê³¼: **ê°™ì€ ë²ˆí˜¸ê°€ ì—¬ëŸ¬ ì°¸ê°€ìì—ê²Œ í• ë‹¹ë  ìˆ˜ ìˆìŒ**

**2. asyncio.Lockì˜ í•œê³„**
- `asyncio.Lock`ì€ **ë‹¨ì¼ í”„ë¡œì„¸ìŠ¤ ë‚´ì—ì„œë§Œ ìœ íš¨**
- Serverless í™˜ê²½ì—ì„œëŠ” í”„ë¡œì„¸ìŠ¤ ê°„ ë™ê¸°í™” ë¶ˆê°€
- ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œëŠ” ì •ìƒ ì‘ë™í•˜ì§€ë§Œ, í”„ë¡œë•ì…˜ì—ì„œëŠ” ì‹¤íŒ¨

#### ğŸ“Š ì‹œë‚˜ë¦¬ì˜¤ë³„ ì˜ˆìƒ ë™ì‘

| ì‹œë‚˜ë¦¬ì˜¤ | ì¸ìŠ¤í„´ìŠ¤ ìˆ˜ | ê²°ê³¼ |
|---------|-----------|------|
| ë¡œì»¬ ê°œë°œ (ë‹¨ì¼ ì„œë²„) | 1 | âœ… ì •ìƒ (Lock ìœ íš¨) |
| Vercel - ìˆœì°¨ ìš”ì²­ | 1 (warm) | âœ… ì •ìƒ (ê°™ì€ ì¸ìŠ¤í„´ìŠ¤) |
| Vercel - ë™ì‹œ 300ëª… | 10~50 | âŒ ë²ˆí˜¸ ì¤‘ë³µ ë°œìƒ |

#### ğŸ’¡ ê¶Œì¥ í•´ê²° ë°©ì•ˆ

**ë°©ì•ˆ 1: Redisë¥¼ í™œìš©í•œ ë¶„ì‚° ë½ + ì¹´ìš´í„° (ê¶Œì¥)** â­

```python
# êµ¬í˜„ ì˜ˆì‹œ
import redis
import asyncio

redis_client = redis.Redis(host='redis-host', port=6379, decode_responses=True)

async def register_participant(event_id: str) -> Dict:
    lock_key = f"lock:luckydraw:{event_id}"
    counter_key = f"counter:luckydraw:{event_id}"

    # Redis ë¶„ì‚° ë½ íšë“ (ìµœëŒ€ 5ì´ˆ ëŒ€ê¸°)
    with redis_client.lock(lock_key, timeout=5):
        # ì›ìì  ì¦ê°€
        draw_number = redis_client.incr(counter_key)

        # ì°¸ê°€ì ì •ë³´ ì €ì¥
        participant_key = f"participant:{event_id}:{session_token}"
        redis_client.hset(participant_key, mapping={
            "draw_number": draw_number,
            "created_at": datetime.now().isoformat()
        })

    return {"draw_number": draw_number, ...}
```

**ì¥ì **:
- âœ… ì¸ìŠ¤í„´ìŠ¤ ê°„ ê³µìœ  ê°€ëŠ¥
- âœ… `INCR` ëª…ë ¹ì–´ë¡œ ì›ìì  ë²ˆí˜¸ í• ë‹¹
- âœ… ë¶„ì‚° ë½ìœ¼ë¡œ ë™ì‹œì„± ì™„ë²½ ì œì–´
- âœ… ë°ì´í„° ì˜ì†ì„± (ì„œë²„ ì¬ì‹œì‘ ì‹œì—ë„ ìœ ì§€)

**ë‹¨ì **:
- Redis ì„œë²„ í•„ìš” (Upstash, Redis Cloud ë“± ë¬´ë£Œ í‹°ì–´ ê°€ëŠ¥)
- ë„¤íŠ¸ì›Œí¬ ì§€ì—° ì¶”ê°€ (~5ms)

**ë°©ì•ˆ 2: PostgreSQL/Supabase í™œìš©**

```python
# Supabase PostgreSQL ì˜ˆì‹œ
async def register_participant(event_id: str) -> Dict:
    result = await supabase.rpc(
        'register_luckydraw_participant',
        {'p_event_id': event_id, 'p_session_token': session_token}
    ).execute()

    return result.data

# PostgreSQL Function (ì›ìì  ì²˜ë¦¬)
"""
CREATE OR REPLACE FUNCTION register_luckydraw_participant(
    p_event_id UUID,
    p_session_token TEXT
) RETURNS INTEGER AS $$
DECLARE
    v_draw_number INTEGER;
BEGIN
    INSERT INTO luckydraw_participants (event_id, session_token, draw_number)
    SELECT p_event_id, p_session_token,
           COALESCE(MAX(draw_number), 0) + 1
    FROM luckydraw_participants
    WHERE event_id = p_event_id
    ON CONFLICT (event_id, session_token) DO NOTHING
    RETURNING draw_number INTO v_draw_number;

    RETURN v_draw_number;
END;
$$ LANGUAGE plpgsql;
"""
```

**ì¥ì **:
- âœ… íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì›ìì„± ë³´ì¥
- âœ… ì˜êµ¬ ì €ì¥
- âœ… Supabase ë¬´ë£Œ í‹°ì–´ í™œìš© ê°€ëŠ¥

**ë‹¨ì **:
- DB ì—°ê²° ì˜¤ë²„í—¤ë“œ
- ë³µì¡í•œ ì¿¼ë¦¬ í•„ìš”

**ë°©ì•ˆ 3: Vercel KV (Serverless Redis)**

```python
# Vercel KV í™œìš© (Vercel í™˜ê²½ì— ìµœì í™”)
from vercel_kv import KV

kv = KV()

async def register_participant(event_id: str) -> Dict:
    counter_key = f"luckydraw:{event_id}:counter"

    # ì›ìì  ì¦ê°€ (INCR)
    draw_number = await kv.incr(counter_key)

    # ì°¸ê°€ì ì •ë³´ ì €ì¥
    await kv.hset(f"luckydraw:{event_id}:participants", {
        session_token: json.dumps({
            "draw_number": draw_number,
            "created_at": datetime.now().isoformat()
        })
    })

    return {"draw_number": draw_number, ...}
```

**ì¥ì **:
- âœ… Vercel í™˜ê²½ì— ì™„ë²½ í†µí•©
- âœ… ì„¤ì • ê°„ë‹¨ (vercel.jsonë§Œ ìˆ˜ì •)
- âœ… ë¬´ë£Œ í‹°ì–´: 30,000 ìš”ì²­/ì¼

**ë‹¨ì **:
- Vercel ì¢…ì†

#### ğŸ“ˆ ì„±ëŠ¥ ì˜ˆì¸¡

| ë°©ì•ˆ | 300ëª… ë™ì‹œ ì²˜ë¦¬ ì‹œê°„ | ë²ˆí˜¸ ì¤‘ë³µ | ë¹„ìš© |
|-----|-------------------|----------|------|
| í˜„ì¬ (ë©”ëª¨ë¦¬) | ~1ì´ˆ | âŒ ë°œìƒ | ë¬´ë£Œ |
| Redis | ~2-3ì´ˆ | âœ… ì—†ìŒ | ë¬´ë£Œ~$10/ì›” |
| PostgreSQL | ~3-5ì´ˆ | âœ… ì—†ìŒ | ë¬´ë£Œ~$25/ì›” |
| Vercel KV | ~2ì´ˆ | âœ… ì—†ìŒ | ë¬´ë£Œ~$10/ì›” |

#### ğŸ¯ ê¶Œì¥ êµ¬í˜„ ìˆœì„œ

1. **ì¦‰ì‹œ ì ìš© (í˜„ì¬ MVP)**
   - í˜„ì¬ ë©”ëª¨ë¦¬ ê¸°ë°˜ ìœ ì§€
   - ë‹¨, ë™ì‹œ ì ‘ì† 50ëª… ì´í•˜ë¡œ ì œí•œ ê¶Œì¥
   - QR ì½”ë“œ ê³µê°œ ì‹œì ì„ ë¶„ì‚° (ê·¸ë£¹ë³„ ìŠ¤ìº”)

2. **ë‹¨ê¸° ê°œì„  (1-2ì£¼)**
   - Vercel KV ë˜ëŠ” Upstash Redis ë„ì…
   - `INCR` ëª…ë ¹ì–´ë¡œ ì›ìì  ë²ˆí˜¸ í• ë‹¹
   - ë¶„ì‚° ë½ êµ¬í˜„

3. **ì¥ê¸° ê°œì„  (1ê°œì›”+)**
   - PostgreSQL ë„ì…
   - ì˜êµ¬ ì €ì¥ ë° ì´ë ¥ ê´€ë¦¬
   - WebSocket ì‹¤ì‹œê°„ í†µì‹  êµ¬í˜„

#### âš ï¸ ì„ì‹œ í•´ê²°ì±… (í˜„ì¬ ìƒíƒœ ìœ ì§€ ì‹œ)

í”„ë¡œë•ì…˜ ë°°í¬ ì „ê¹Œì§€ ë‹¤ìŒ ë°©ë²•ìœ¼ë¡œ ë¬¸ì œë¥¼ ì™„í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

1. **QR ìŠ¤ìº” ìˆœì„œ ê´€ë¦¬**
   - í…Œì´ë¸”ë³„/ê·¸ë£¹ë³„ë¡œ ìˆœì°¨ ìŠ¤ìº” ìœ ë„
   - "1ë²ˆ í…Œì´ë¸”ë¶€í„° ì°¨ë¡€ë¡œ ìŠ¤ìº”í•´ì£¼ì„¸ìš”" ì•ˆë‚´

2. **Cold Start ë°©ì§€**
   - ì´ë²¤íŠ¸ ì‹œì‘ ì „ ë”ë¯¸ ìš”ì²­ìœ¼ë¡œ ì¸ìŠ¤í„´ìŠ¤ Warm-up
   - `curl https://your-api.vercel.app/api/health`

3. **í”„ë¡ íŠ¸ì—”ë“œ ì¬ì‹œë„ ë¡œì§**
   ```javascript
   // ì¤‘ë³µ ë²ˆí˜¸ ê°ì§€ ì‹œ ì¬ë“±ë¡
   async function registerWithRetry() {
     const result = await fetch('/api/register');
     if (result.draw_number === previousNumber) {
       // ì¬ì‹œë„
       await new Promise(r => setTimeout(r, 1000));
       return registerWithRetry();
     }
     return result;
   }
   ```

---

## ğŸ”§ ê°œë°œ ê°€ì´ë“œ

### ë¡œì»¬ í…ŒìŠ¤íŠ¸

```bash
# í”„ë¡ íŠ¸ì—”ë“œ
cd front
npm run dev  # http://localhost:3000

# ë°±ì—”ë“œ
cd server
python main.py  # http://localhost:8000
```

### API í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ

```bash
# ì°¸ê°€ì ë“±ë¡
curl -X POST http://localhost:8000/api/luckydraw/register \
  -H "Content-Type: application/json" \
  -d '{"event_id": "test-event-1"}'

# ì°¸ê°€ì ëª©ë¡ ì¡°íšŒ
curl http://localhost:8000/api/luckydraw/admin/test-event-1/participants

# ì¶”ì²¨ ì‹¤í–‰
curl -X POST http://localhost:8000/api/luckydraw/admin/test-event-1/draw \
  -H "Content-Type: application/json" \
  -d '{"prize_name": "1ë“±", "prize_rank": 1, "count": 1}'
```

---

## ğŸ“š ê´€ë ¨ ë¬¸ì„œ

- [Lucky Draw API ê³„íš](./api/LUCKYDRAW_API_PLAN.md)
- [MVP API ëª…ì„¸ì„œ](./api/MVP_API_SPEC.md)
- [ë°ì´í„° í”Œë¡œìš°](./design/DATA_FLOWS.md)
- [ì‚¬ìš©ì í”Œë¡œìš°](./design/USER_FLOWS.md)

---

## ğŸ“ ë³€ê²½ ì´ë ¥

| ë²„ì „ | ë‚ ì§œ | ë³€ê²½ ë‚´ìš© |
|-----|------|----------|
| 1.0 | 2025-11-30 | ì´ˆê¸° ë¬¸ì„œ ì‘ì„± |

